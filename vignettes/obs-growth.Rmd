---
title: "COVID-19 Growth in Virginia"
author: "Robert Link"
date: "4/1/2020"
output:
  html_document:
    df_print: paged
  pdf_document: default
  rmarkdown::html_vignette: default
vignette: |
  %\VignetteIndexEntry{COVID-19 Growth in Virginia} %\VignetteEncoding{UTF-8} %\VignetteEngine{knitr::rmarkdown}
---

```{r setup}
suppressPackageStartupMessages(library(dplyr))
library(tidyr)
library(ggplot2)
library(CovMitigation)
library(ggthemes)
library(latex2exp)
```

## Assumptions

We have to make a slight approximation here.  The growth rate we are interested
in is the growth in active cases, which is affected by both the infection rate and
the recovery rate.  The data from the department of health only has new cases (which
grow a little more slowly) and cumulative cases (which grow a little faster).  For
this analysis we went with new cases.

## Growth observations

```{r growthrate, fig.width=7, fig.height=4}
basedate <- as.Date('2020-03-16')
pltdata <- 
  select(uvads_covid19, date, vaNewCases, ftest, ntest) %>%
  filter(vaNewCases > 0, ftest > 0, date >= basedate)
t <- seq_along(pltdata$date) - 1  # start at zero
pltdata$t <- t

## Compute the testing fraction correction.
idx <- 3
ftest_relative <- pltdata$ftest / pltdata$ftest[1]
#fcorrect <- min(pltdata$ftest) / pltdata$ftest

pltdata$correctedNewCases <- pltdata$vaNewCases / ftest_relative 
pltdata$correctedCumCases <- cumsum(pltdata$correctedNewCases)
pltdata$correctedCumCases <- pltdata$correctedCumCases / pltdata$correctedCumCases[idx]

## Label positioning
lastidx <- length(t)
lastdate <- pltdata$date[lastidx]

## Create the benchmark data
tds <- c(3,4,5,6,7)
tdlabs <- paste('td=',tds)
tdlabstex <- sprintf('$t_d = %d$', tds)
gr <- lapply(tds, 
             function(td) {
               r <- log(2)/td
               exp(r*t) / exp(r*t[idx])
             })
benchmarks <- as.data.frame(gr)
names(benchmarks) <- tdlabs
benchmarks$date <- t + pltdata$date[1]
benchmarks <- pivot_longer(benchmarks, -date, names_to = 'doubling time')
benchplt <- 
  ggplot(data=pltdata, aes(x=date)) + 
  geom_line(data=pltdata, mapping=aes(y=correctedCumCases), size=1.2) +
  geom_line(data=benchmarks, mapping=aes(y=value, group=`doubling time`), color='lightgrey') +
  scale_color_solarized() +
  scale_y_log10() +
  theme_bw()
for(i in seq_along(gr)) {
  benchplt <- benchplt + geom_label(x=lastdate, y=log10(gr[[i]][lastidx]), label=TeX(tdlabstex[i]))
}
suppressWarnings(print(benchplt))
```

```{r ffxgrowth}
basedate <- as.Date('2020-03-16')
ffxdata <- filter(NYTimesCOVID19::cov19county, fips==51059,)
ffxdata$newCases <- c(0, diff(ffxdata$cases))
ffxdata <- 
  left_join(ffxdata, select(uvads_covid19, date, ftest), by='date') %>%
  select(date, newCases, ftest) %>%
  filter(ftest > 0, date >= basedate)

t <- seq_along(ffxdata$date) - 1  # start at zero
ffxdata$t <- t

## Compute the testing fraction correction.
idx <- 3
ftest_relative <- ffxdata$ftest / ffxdata$ftest[1]
#fcorrect <- min(ffxdata$ftest) / ffxdata$ftest

ffxdata$correctedNewCases <- ffxdata$newCases / ftest_relative 
ffxdata$correctedCumCases <- cumsum(ffxdata$correctedNewCases)
ffxdata$correctedCumCases <- ffxdata$correctedCumCases / ffxdata$correctedCumCases[idx]

## Label positioning
lastidx <- length(t)
lastdate <- ffxdata$date[lastidx]

## Create the benchmark data
tds <- c(3,4,5,6,7)
tdlabs <- paste('td=',tds)
tdlabstex <- sprintf('$t_d = %d$', tds)
gr <- lapply(tds, 
             function(td) {
               r <- log(2)/td
               exp(r*t) / exp(r*t[idx])
             })
benchmarks <- as.data.frame(gr)
names(benchmarks) <- tdlabs
benchmarks$date <- t + ffxdata$date[1]
benchmarks <- pivot_longer(benchmarks, -date, names_to = 'doubling time')
benchplt <- 
  ggplot(data=ffxdata, aes(x=date)) + 
  geom_line(data=ffxdata, mapping=aes(y=correctedCumCases), size=1.2) +
  geom_line(data=benchmarks, mapping=aes(y=value, group=`doubling time`), color='lightgrey') +
  scale_color_solarized() +
  scale_y_log10() +
  theme_bw()
for(i in seq_along(gr)) {
  benchplt <- benchplt + geom_label(x=lastdate, y=log10(gr[[i]][lastidx]), label=TeX(tdlabstex[i]))
}
suppressWarnings(print(benchplt))
```
