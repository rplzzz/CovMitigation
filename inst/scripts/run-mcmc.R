library(metrosamp)
library(CovMitigation)
library(doParallel)

pmat <-
  structure(c(5.88746195394305, 5.90793956177837, 5.89613471639557, 
              6.02468741092829, 6.06641530808837, 6.10147520949943, 7.89103847089034, 
              8.28932714803433, 8.62760022070607, 8.14688027756114, 8.70256880893263, 
              8.78094354697475, 10.3946999206565, 8.08614328580999, 7.69621416051828, 
              10.4900023762997, 7.80928225320863, 7.94962360402838, 3.66405849353114, 
              3.40631379502436, 3.48262702272309, 3.54003468134357, 3.49710330355482, 
              3.52216625795103, 3.09408164185108, 2.38408159522129, 2.77385514048705, 
              2.92638174448749, 2.96111406603039, 2.12858300042632, 4.88455897613265, 
              4.45282747183628, 4.27158090244618, 4.81548109236589, 4.57136974519403, 
              4.32271030900459, 20.1565468817403, 24.7124746582754, 31.5814644267786, 
              17.5139677975584, 24.8729260876337, 27.0003867599893, 20.5419284246121, 
              49.5798261203186, 91.4042152244011, 20.0377723818836, 50.0997057565297, 
              90.7519476006041), .Dim = c(6L, 8L), 
            .Dimnames = list(NULL, c("T0_hi", 
                                     "T0", "D0", "A0", "I0", "Ts", "day_zero", "b")))


sclmat <-
  structure(c(0.00338015305650051, 0.00441529027492092, -0.0150085956397609, 
              0.000679325034886075, 0.00120417016648041, -0.00302228419714102, 
              -0.0473100245495748, -0.0844694244107032, 0.00441529027492092, 
              0.00896001883585282, -0.036480684095738, 0.000425842832357986, 
              0.000413417244194303, -0.00670520196925991, -0.00152325951821588, 
              0.221511895976497, -0.0150085956397609, -0.036480684095738, 0.221674024758821, 
              0.00050926872577358, 0.00260745021914954, 0.0457431921114491, 
              -0.202984440168792, -1.743998792293, 0.000679325034886075, 0.000425842832357986, 
              0.00050926872577358, 0.00131020785010738, 0.000517008715524991, 
              0.00039587654520796, -0.0228018612257832, -0.0872696643525429, 
              0.00120417016648041, 0.000413417244194303, 0.00260745021914954, 
              0.000517008715524991, 0.00625154985154253, -0.0011467853002728, 
              -0.0304958934232297, -0.195429098947888, -0.00302228419714102, 
              -0.00670520196925991, 0.0457431921114491, 0.00039587654520796, 
              -0.0011467853002728, 0.0119745496788043, -0.0465905202174903, 
              -0.352725399072631, -0.0473100245495748, -0.00152325951821588, 
              -0.202984440168792, -0.0228018612257832, -0.0304958934232297, 
              -0.0465905202174903, 2.10559720618872, 8.72619346690454, -0.0844694244107032, 
              0.221511895976497, -1.743998792293, -0.0872696643525429, -0.195429098947888, 
              -0.352725399072631, 8.72619346690454, 44.5325732021925), 
            .Dim = c(8L, 8L), 
            .Dimnames = list(c("T0_hi", "T0", "D0", "A0", "I0", "Ts", 
                               "day_zero", "b"), c("T0_hi", "T0", "D0", "A0", "I0", "Ts", "day_zero", 
                                                   "b")))

lpost <- gen_post()

run_mcmc <- function(tid, nsamp, outfilename, restartfile=NULL, 
                     nproc=8, nwarmup = 1000, usescl=TRUE)
{
  if(is.na(nproc) || nproc==1) {
    foreach::registerDoSEQ()
  } else {
    registerDoParallel(cores=nproc)
  }
  
  set.seed(867-5309 + tid)
  if(is.null(restartfile)) {
    ## Distribute the samplers amongst the optimization results.
    irow <- 1 + tid%%nrow(pmat)    
    pstrt <- pmat[irow,]
    
    mcwarmup <- metrosamp(lpost, pstrt, nwarmup, 1, scl)
    mcs <- metrosamp(lpost, mcwarmup, nsamp, 1)
  }
  else {
    mcwarmup <- readRDS(restartfile)
    if(usescl) {
      mcs <- metrosamp(lpost, mcwarmup, nsamp, 1, scl)
    } else {
      mcs <- metrosamp(lpost, mcwarmup, nsamp,1)
    }
  }
  
  if(!is.null(restartfile) && outfilename == restartfile) {
    file.rename(restartfile, namebackup(restartfile))
  }
  saveRDS(mcs, outfilename, compress='xz')
  
  cat('\nFIN.\n')
}
